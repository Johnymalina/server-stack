networks:
  cloudflared:
    name: cloudflared
services:
  cloudflared:
    command: tunnel --no-autoupdate run
    container_name: cloudflared
    environment:
      TUNNEL_TOKEN: >-
        eyJhIjoiOGNlODA4ZjBhMzM1ODk4MGIzOTBlYTgzMGE4ZGYzYzYiLCJ0IjoiZDExMjA4OTMtYzBhNC00ZjFkLWE5YzUtNTc2ZWU0MTQwNjgxIiwicyI6Ik9EVTVOREUwT0dRdE9XUTNNaTAwTldKa0xUa3hZMk10TVdRNE5qWTJPV05pWlRRNSJ9
      TZ: Europe/Zurich
    image: cloudflare/cloudflared
    networks:
      - cloudflared
    restart: unless-stopped

  traefik:
    container_name: traefik
    # environment:
    #   CF_DNS_API_TOKEN: 80lUICJN2hOjwEamgEhMdZHucCDvOJUKxjxQhSOJ
    image: traefik:latest
    restart: unless-stopped
    networks:
      - cloudflared
    ports:
      - '80:80'
      - '443:443'
      - '8080:8080'

    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./appdata/traefik/acme.json:/acme.json
      - ./appdata/traefik/config.yml:/config.yml
      - ./appdata/traefik/traefik.yml:/traefik.yml:ro

  authelia:
    container_name: authelia
    image: docker.io/authelia/authelia:latest
    restart: unless-stopped
    networks:
      - cloudflared
    ports:
      - '9091:9091'
    environment:
      PUID: 1000
      PGID: 1000
      TZ: Europe/Zurich
      AUTHELIA_IDENTITY_VALIDATION_RESET_PASSWORD_JWT_SECRET_FILE: /secrets/JWT_SECRET
      AUTHELIA_SESSION_SECRET_FILE: /secrets/SESSION_SECRET
      AUTHELIA_STORAGE_ENCRYPTION_KEY_FILE: /secrets/STORAGE_ENCRYPTION_KEY
      AUTHELIA_NOTIFIER_SMTP_PASSWORD_FILE: /secrets/NOTIFIER_SMTP_PASSWORD

    volumes:
      - ./appdata/authelia/config:/config
      - ./appdata/authelia/secrets:/secrets
      - ./appdata/authelia/db:/db